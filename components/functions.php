<?php
function fetchPostsAndComments($conn)
{
    $htmlOutput = '';
    $searchTerm = isset($_GET['search']) ? $_GET['search'] : '';
    if ($searchTerm != '') {
        echo "Searching for $searchTerm";
        echo "<br>";
    }

    // Fetch posts
    $sql = $conn->prepare("SELECT p.id, p.title, p.content, u.username, p.created_at FROM posts p JOIN users u ON p.user_id = u.id WHERE p.title LIKE CONCAT('%', ?, '%') ORDER BY p.created_at DESC");
    $sql->bind_param("s", $searchTerm);

    $sql->execute();
    $result = $sql->get_result();

    if ($result->num_rows > 0) {
        $htmlOutput .= "<div class='accordion' id='postsAccordion'>"; // Start of the accordion

        // Output data of each post
        while ($post = $result->fetch_assoc()) {
            $postId = $post['id']; // Get the post ID

            // Each post is a card and part of the accordion
            $htmlOutput .= "<div class='accordion-item'>";
            $htmlOutput .= "<div class='accordion-header' id='heading$postId'>";
            $htmlOutput .= "<button class='accordion-button' type='button'data-bs-toggle='collapse' data-bs-target='#collapse$postId' aria-expanded='true' aria-controls='collapse$postId'>";
            $htmlOutput .= "<h2 class='mb-0'>";
            $htmlOutput .= htmlspecialchars($post['title']);
            $htmlOutput .= "</h2>";
            $htmlOutput .= "</button>";

            $htmlOutput .= "</div>";

            $htmlOutput .= "<div id='collapse$postId' class='accordion-collapse collapse' aria-labelledby='heading$postId' >";
            $htmlOutput .= "<div class='accordion-body'>";
            $htmlOutput .= "<p class='fs-5'>" . nl2br(htmlspecialchars($post['content'])) . "</p>";
            $htmlOutput .= "<small class='text-muted'>Posted by " . "<p class='fs-6'>" . htmlspecialchars($post['username']) . " on " . $post['created_at'] . "</p>" . "</small>";

            $htmlOutput .= "</div>"; // End of card-body
            $htmlOutput .= "</div>"; // End of collapse
            $htmlOutput .= "</div>"; // End of card
        }

        $htmlOutput .= "</div>"; // End of the accordion
    } else {
        $htmlOutput .= "No posts found.";
    }

    return $htmlOutput;
}

function createPost($conn)
{
    if (isset($_POST['submitPost'])) {
        $title = $_POST['title'];
        $content = $_POST['content'];
        $userId = $_SESSION['user_id']; // Assuming you have the user's ID stored in the session

        // Prepare an SQL statement to prevent SQL injection
        $stmt = $conn->prepare("INSERT INTO posts (user_id, title, content) VALUES (?, ?, ?)");
        $stmt->bind_param("iss", $userId, $title, $content);

        if ($stmt->execute()) {
            echo "New post created successfully";
            // Redirect to a different page or show a success message
        } else {
            echo "Error: " . $stmt->error;
        }

        $stmt->close();
    }

}

?>
